# my_web

## 基于《Linux高性能服务器》开发的轻量级服务器

my_web

```
实现的功能
使用 线程池 + 非阻塞socket + epoll(ET和LT) + （reactor&proactor）事件处理的并发模型
使用状态机解析HTTP请求报文，支持POST与GET请求解析
通过服务器数据库实现用户的登录注册
实现同步/异步（基于阻塞队列）日志系统，监控服务器状态
经Webbench压力测试可以实现上万的并发连接数据交换

改进定时器 使用定时堆来提高效率
通过LRU缓存来记录用户登录信息, 实现用户短期登录主页不需要登录

后面有时间会实现文件的下载和上传
```



​    第一版
​      这是最简单web服务器  
​      涉及的知识有 socket, epoll, http协议  
​      简单的守护进程和信号处理  
​      未来将继续改进        
​      开始重做 涉及方面过少且存在一些问题
​      \
​    第二版          
​      将通过学习游双的《Linux高性能服务器》重写该项目

​	 涉及知识:

​				1.使用线程池 + 非阻塞socket + epoll + （reactor&proactor）事件处理的并发模型

​				2.使用有限状态机解析HTTP请求报文 , 暂时仅支持GET (后面会添加上POST)

​	遇到的问题:

​				1.服务器启动后线程没有开始处理任务 

​					发现是run函数的请求数组没有运行process

​				2.输出的分析字符串只有HOST

​					发现是中间一段的判断打少了= 

​	

第三版 完善和改进

# 遇到的问题

3月10号

		服务器启动后线程没有开始处理任务 
	
					发现是run函数的请求数组没有运行process
	
		输出的分析字符串只有HOST
	
					发现是中间一段的判断打少了= 
3月11号
	1.发现问题 无法发送大文件
	推测大文件应该有之前的(bytes_to_send <= bytes_have_send) 有关
	已解决
		
	2.请求带有中文时会出现乱码
	因为中文解码成别的 比如苦会变成e88ba6
	添加一个解码函数 翻译中文
	
	但服务器回复的中文消息依旧是乱码 (不知道怎么解决
	
	已解决:
		不需要编码成中文 好像linux就自动识别了 只是没显示
		返回的信息头部需要加Content-Type,浏览器就可以自动转码了
		(但是看了几个源码没人遇到这个事情,百思不得其解)
	3文件传输总是会卡住 但服务器一断开就又正常
	4视频和音频文件无法播放

3月12号
	1解决昨天的中文问题
	2小小小改进 不用再输入ip地址
	3视频音频问题依旧无法解决 但是在linux服务器上可以正常运行 不知道为什么
	
	今天目标: 完成定时器
	失败: 加入定时器后一直获得SIGTREP 重启虚拟机后正常
	        网页无法正常加载 有图片的话要刷新才能显示 解决 发现是epoll循环中的write判断出错了
3月13号
	
	1视频音频问题好像是网页连接无法长时间保持 无法在线加载 客户端会自动断开连接 暂时找不到解决方法
	2 大文件依旧可以正常下载
	3 这个问题可能要等自己把网页做出来才能解决 所以暂时搁置
	4 今天目标是日志系统: 完成
	5 完成对web类的封装 可以提高观看效率 和 容易扩展
3月14号
	1运行昨天完成的封装 发生段错误  
	原因: 没有线程池初始化时所需要的变量没有初始化
	2 新bug 当传输文件时 网页刷新  会连接上，之后不进行读事件，而是直接触发EPOLLRDHUP信号，
	该浏览器的任何链接都会触发该信号
	原因 应该是ET触发 , 在连接accept时没有循环读取信息 导致之前没有处理的信号被接收到
	解决 将accept_client改成循环 将信息处理掉
	3 今天目标 完成数据库和post解析 以及压力尝试
	4 压力尝试使用网络上的代码 并关闭日志
	5完成失败 
	 浪费了大量的时间在centos8的yum问题和mysql没有按照应有路径生成随机密码

3月15号

	1继续完成昨天的任务
	
	2发现之前写的中文转码等东西可能不需要了  保存源码但不使用
	
	3创建数据库

```cpp
mysql> create DATABASE RUNOOB;
```

创建表和数据

```cpp
mysql>USE yourdb;
        CREATE TABLE user(
            username char(50) NULL,
            passwd char(50) NULL
        )ENGINE=InnoDB;

// 添加数据
    INSERT INTO user(username, passwd) VALUES('name', 'passwd');
```

网页的使用暂时使用Tinyweb的 后续可能会修改

		4一些bug的修改
	
		5实现LT和ET Reactor和Proactor

3月16号
	1进行压测
	发现效果非常不理想

	关闭日志再次压测 效果提高了一倍但依旧不达到遇期
	
	同时压测的bytes/sec一直为0 不知道为什么
	
	找到原因 使用的webbench默认是HTTP/1.0 之前的代码无法解析  修改后正常



![image-20220316162816947](C:\Users\1780484247\AppData\Roaming\Typora\typora-user-images\image-20220316162816947.png)

由于虚拟机和电脑配置问题无法进行更大规模的压测 请见谅

改回原来的配置



到此 基础部分基本完成 接下来是优化和实现动态网页



2 完成定时器的改进 改为定时堆  因为该定时堆空间容易膨胀 所以不使用压测  
3 发现数据库读取和写入都是乱码  已解决 是输出的问题 与输入无关  
4 打开日志后 运行服务器 会有一定几率段错误	  

5 加入LRU类 仿照session的记忆 短期内可以记录用户的信息  如果用户直接登录主页 之前有登录可以进入 , 没有登录过则不能登录  

## 感谢

游双老师的《Linux高性能服务器》

qinguoyi的TinyWebServer
